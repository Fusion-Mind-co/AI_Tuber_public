# AITuberツール設計書

## 1. 概要

AI VTuberとリスナーの1対多のライブストリーミングシステム。  
パーソナライズされたコメント応答とユーザー管理機能を提供する。

## 2. システム構成

### 2.1 技術スタック
- **バックエンド**: Flask
- **フロントエンド**: Vite
- **LLM**: Gemini (仮)
- **音声合成**: Style-Bert-VITS2 (感情コントロール対応)
- **キャラクターモデル**: 検討中 (リップシンク連携予定)
- **センシティブ判定**: A2A的AI活用

### 2.2 アーキテクチャ
```
[YouTube/TikTok] → [コメント取得] → [センシティブ判定AI] → [コメント整理・厳選] → [LLM処理] → [感情付きTTS] → [リップシンク] → [配信出力]
                                    ↓                                          ↓              ↓
                              [ユーザーDB] ← [点数化システム]              [PC負荷監視] → [安全装置]
```

## 3. 主要機能

### 3.1 コメント処理機能

#### コメント取得
- **対応プラットフォーム**: 
  - YouTube: `pytchat`ライブラリ
  - TikTok: `TikTokLive`ライブラリ
- **リアルタイム取得**: WebSocket/API連携

#### コメント整理・厳選
**AI判定システム**:
- **センシティブ判定AI**: A2A的な活用でコメント内容を自動判定
- **リアルタイム分析**: 不適切内容の即座な検出・除外

**除外対象**:
- センシティブな内容 (AI自動判定)
- 意味が分からない内容
- スパム・重複コメント

**優先度判定**:
1. そのコメントに対しての内容
2. 話の流れとの整合性  
3. ユーザーのパーソナライズ情報

### 3.2 メモリ管理システム

**課題**: 記憶量多 = ユーザー満足度大 / トークンリソース過多

**解決策**:
- 過去の不要な会話を削除するロジック
- 重要度に基づく記憶の優先順位付け
- ユーザー別の記憶重み付け

## 4. ユーザー管理システム

### 4.1 データベース構造

| 項目 | 型 | 説明 | 例 |
|------|-----|------|-----|
| 名前 | String | ユーザー名 | あおい |
| 趣味 | String | 主な興味・関心 | モンハン |
| コメント数 | Integer | 総コメント数 | 150 |
| 初めてのコメント | DateTime | 初回コメント日時 | 2025-05-31 15:00:00 |
| 最終コメント日時 | DateTime | 最新コメント日時 | 2025-07-30 15:00:00 |
| チャンネル登録 | Boolean | 登録状況 | true |
| センシティブ100点満点 | Integer | 問題行動スコア(0-100) | 30 |
| スパチャ累計 | Integer | 投げ銭総額 | 3000 |
| 加点 | Integer | 正の評価点 | 70 |
| 減点 | Integer | 負の評価点 | 30 |
| 総合得点 | Integer | 最終スコア | 40 |
| 最近した会話 | String | 直近の会話内容 | モンハンワイルズって... |

### 4.2 点数化システム

**加点要素**:
- 会話数: 多いほど高得点
- 古参度: 初回コメントが古いほど高得点  
- スパチャ額: 金額に応じて加点
- チャンネル登録: +10点

**減点要素**:
- センシティブコンテンツ: 違反内容に応じて減点
- スパム行為: 迷惑行為による減点

### 4.3 パーソナライゼーション機能

**ユーザー別対応**:
- **登録者**: 「○○さん、いつも来てくれてありがとう」
- **未登録者**: 「○○さんコメントありがとう。ぜひチャンネル登録よろしくお願いします」
- **VIPユーザー**: 過去の会話を踏まえた深い関係性演出

**重要な配慮**:
- 初めましてじゃない人に「初めまして」と言わない
- 名前を積極的に呼ぶ
- お得意様情報の継承

## 5. 音声・映像システム

### 5.1 音声合成システム (Style-Bert-VITS2)

**感情コントロール機能**:
- **感情パラメータ**: 喜び、怒り、悲しみ、驚き、平常の5段階制御
- **LLM連携**: 応答内容に基づく自動感情判定
- **ユーザー情報反映**: VIPユーザーには親しみやすい声色、新規には丁寧な声色

**音声品質管理**:
- **リアルタイム生成**: 低遅延での音声合成
- **感情切り替え**: 文脈に応じたスムーズな感情遷移
- **音声キャッシュ**: 頻出フレーズの事前生成

### 5.2 映像システム

**リップシンク機能** (検討中):
- **音素解析**: TTS出力との音素レベル同期
- **口形制御**: 日本語音素に対応した口の形状変化
- **遅延調整**: 音声と映像の同期ずれ補正

**キャラクターモデル** (検討中):
- **表情制御**: 感情に応じた表情変化
- **アイドルモーション**: 無言時の自然な動作
- **インタラクション**: コメント応答時の身振り手振り

## 6. システム監視・安全装置

### 6.1 PC負荷監視システム

**リアルタイム負荷視認化**:
- **CPU使用率**: リアルタイムグラフ表示
- **メモリ使用量**: 利用可能メモリの監視
- **GPU使用率**: キャラクターモデル描画負荷
- **ネットワーク**: コメント取得・配信の通信状況

**監視項目**:
```
- CPU: 85%以上で警告、95%以上で制限
- メモリ: 90%以上で警告、95%以上で制限  
- GPU: 80%以上で警告、90%以上で制限
- 温度: 80℃以上で警告、85℃以上で制限
```

### 6.2 負荷対応安全装置

**自動負荷軽減**:
- **処理優先度調整**: 高負荷時はVIPユーザー優先
- **品質動的調整**: TTS品質・キャラモデル解像度の自動降下
- **機能制限**: リップシンク一時停止、感情制御簡略化

**段階的制限システム**:
1. **軽度負荷** (CPU 85%～): 新規ユーザーの応答頻度制限
2. **中度負荷** (CPU 90%～): TTS品質を標準→高速モードに変更
3. **高度負荷** (CPU 95%～): キャラモデル描画フレームレート削減
4. **緊急時** (CPU 98%～): コメント処理一時停止、システム保護モード

**復旧機能**:
- **負荷低下検知**: 安定状態への自動復帰
- **段階的復旧**: 機能の順次再開
- **ログ記録**: 負荷発生原因の分析・改善

## 7. 応答生成システム

### 7.1 処理フロー
1. **コメント受信**
2. **センシティブ判定AI** による内容チェック
3. **ユーザー識別・情報取得**
4. **コンテキスト構築** (過去会話 + ユーザー情報)
5. **LLM応答生成** (感情情報付き)
6. **感情付きTTS音声合成**
7. **リップシンク処理** (検討中)
8. **配信出力**

### 7.2 応答最適化
- **リアルタイム処理**: コメント→応答までの遅延最小化
- **複数コメント対応**: 優先順位に基づく処理順序
- **つなぎトーク**: LLM処理時間中の自動フィラー
- **負荷分散**: PC負荷に応じた処理品質調整

## 8. 追加機能

### 8.1 話題提供機能

**ハイブリッド方式による話題取得**:
- **メイン**: Python RSS feeds + スクレイピング（安定性・コスト重視）
- **サブ**: Xトレンド取得、LLM検索機能（Gemini等）による話題補完・要約

**Pythonライブラリベース実装**:
- **日本ニュース見出し取得**: feedparserでNHK、朝日、Yahoo!等のRSS取得
- **Xトレンド取得**: snscrape（無料・認証不要）またはTweepy（公式API）
- **実装コスト**: 0円～（RSS完全無料、API任意）
- **定期実行**: 15分間隔でニュース更新、1時間間隔でトレンド更新

**話題活用アプローチ**:
- **考察重視ではなく会話の入り口として活用**
- **ニュースから視聴者参加型トークへ発展**

*実装例*:
```
入学式ニュース → 「みんなはランドセル派？それ以外派？」
桜開花ニュース → 「お花見の思い出聞かせて」
スポーツ結果 → 「みんなの推しチーム教えて」
```

**技術スタック**:
- `feedparser`: RSS feed解析
- `newspaper3k`: 記事内容取得（必要時）
- `snscrape`: Twitter/Xトレンド取得
- `tweepy`: 公式Twitter API（オプション）

### 8.2 安全性対策
- **炎上リスク対策**: 政治・宗教等の話題回避
- **著作権対策**: 楽曲リクエスト等への適切な対応
- **プライバシー保護**: 個人情報の適切な処理
- **AI判定システム**: センシティブ内容の自動検出・除外

## 9. 運用考慮事項

### 9.1 パフォーマンス
- **リアルタイム性**: 応答遅延の最小化
- **スケーラビリティ**: 同時視聴者数増加への対応
- **リソース管理**: トークン使用量の最適化
- **負荷分散**: PC性能に応じた動的品質調整

### 9.2 メンテナンス性
- **ログ管理**: 問題発生時の原因特定
- **設定変更**: キャラクター設定の動的更新
- **データバックアップ**: ユーザーデータの保護
- **負荷監視**: システム状態の可視化・アラート機能

## 10. 今後の拡張可能性

### 10.1 機能拡張
- **感情分析**: ユーザーの感情状態把握
- **関係性データ**: ユーザー同士の関係性分析
- **予測機能**: 離脱リスク・成長ポテンシャル予測
- **高度リップシンク**: より自然な口元表現
- **表情豊かな感情表現**: 微細な感情変化の表現

### 10.2 プラットフォーム拡張
- **他SNS対応**: Twitter/X、Discord等への拡張
- **マルチモーダル**: 画像・動画コメントへの対応
- **ライブ配信以外**: オンデマンド動画での応用

---
**作成者：金子弘典**
**作成日**: 2025年7月31日  
**バージョン**: 1.0